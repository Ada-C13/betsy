<main>
  <h2><%= @merchant.username %>' Dashboard</h2>

  <% if !@merchant.products.empty? %>
  <section class="merchant-products__container">


    <p><strong>Total Revenue: <%= number_to_currency(@merchant.total_revenue) %></strong></p>

    <h3>Total Revenue Breakdown</h3>

    <table class="table">
      <thead>
        <tr>
          <th>Order Status</th>
          <th>Number of Orders</th>
          <th>Total Revenue</th>
        </tr>
      </thead>

      <tbody>

      <% order_statuses = ["paid", "complete", "pending", "cancelled"] %>
      <% order_statuses.each do |status| %>
        <tr>
          <td><%= status %></td>
          <td> <%= @merchant.number_of_orders_for(status) %> </td>
          <td><%= number_to_currency(@merchant.revenue_for(status)) %></td>
        </tr>
      <% end %>

      </tbody>
    </table>


    <h3>Products</h3>

    <table class="table">
      <thead>
        <tr>
          <th>Product Name</th>
          <th>Price</th>
          <th>Active</th>
          <th>Edit</th>
        </tr>
      </thead>

      <tbody>

      <% products = @merchant.products %>
      <% products.each do |product| %>
        <tr>
          <td><%= link_to product.title, product_path(product.id) %></td>
          <td><%= product.price %></td>
          <td><%= product.active == true ? "true" : "false"%></td>
          <td><%= link_to "Edit", edit_product_path(product.id), class: "btn btn-primary" %></td>
        </tr>
      <% end %>

      </tbody>
    </table>

    <% if @merchant.existing_order_items_by_merchant.empty? %>
      <h3>Orders</h3>
      <h4>Sorry, no one has bought any of your products yet..</h4>
    <% else %>
    <%= form_tag(merchant_path(@merchant.id), method: :get) do %>
      <h3>Orders | filter by status <%= select_tag "Status", options_from_collection_for_select(
          @merchant.existing_order_items_by_merchant.map{ |item| item.order}, "status", "status") %></h3>
        <%= submit_tag "Filter", class: "btn btn-primary" %>
    <% end %>
      <table class="table">
        <thead>
          <tr>
            <th>Order number</th>
            <th>Product</th>
            <th>Quantity</th>
            <th>Price per item</th>
            <th>Subtotal</th>
            <th>Placed</th>
            <th>Order status</th>
            <th>Shipment status</th>
          </tr>
        </thead>

        <tbody>

        <% exiting_order_items = @merchant.find_orders_by_status(params["Status"]) %>
        <% exiting_order_items.each do |item| %>
          <tr>
            <td><%= link_to item.order.id, order_path(item.order.id) %></td>
            <td><%= link_to item.product.title, product_path(item.product.id) %></td>
            <td><%= item.quantity %></td>
            <td><%= item.product.price %></td>
            <td><%= item.subtotal %></td>
            <td><%= item.created_at.to_s.to_time.strftime('%B %e, %Y, %T') %></td>
            <td><%= item.order.status%></td>
            <% if item.shipped %>
              <td>Shipped</td>
            <% elsif item.order.status == "pending" || !item.order.status %>
              <td>Should be paid first</td>
            <% else %>
              <td><%= link_to "Ship", ship_item_path(item.id), method: :post, class: "btn btn-primary" %></td>
            <% end %>
          </tr>
        <% end %>

        </tbody>
      </table>
  <% end %>
  </section>
  <% else %>
    <h3>There are currently no products to sell. Please add some.</h3>
  <% end %>
  <%= link_to "Add a new product", new_product_path, class: "btn btn-primary" %>
</main>
